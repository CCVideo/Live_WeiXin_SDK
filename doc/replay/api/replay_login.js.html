<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: replay/login.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: replay/login.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var util = require('./util');
var CONFIG = require('./config');
var http = require('./http');

function Login(opts, state, emitter, cache) {
    this.opts = opts;
    this.data = {};
    this.state = state;
    this.emitter = emitter;
    this.cache = cache;
    this.userId = '';
    this.videoId = '';
    this.room = {};
    this.template = {};
    this.pages = [];
    this.questions = [];
    this.answers = [];
    this.draws = [];
    this.pageChanges = [];
    this.chatLogs = [];
    this.CHATLOGS = [];
}

Login.prototype.login = function (callback) {
    if (!this.checkout()) {
        util.log('初始化参数不正确', this.opts);
        util.callback(this.opts.fail, CONFIG.ERRORCODE_LOGIN_PARAM, '初始化参数不正确', 'error');
        return false;
    }
    this.send(callback);
};

Login.prototype.send = function (callback) {
    var self = this;

    var data = {
        roomid: this.opts.roomId,
        userid: this.opts.userId,
        recordid: this.opts.recordId,
        viewertoken: this.opts.viewertoken || '',
        viewername: this.opts.viewername || ''
    };

    var url = CONFIG.URL.LOGIN;

    var state = {
        isRequestState: this.state.isLoginRequestState,
        setRequestState: this.state.setLoginRequestState
    };

    http.request({
        url: url,
        method: 'GET',
        data: data,
        state: state,
        log: 'login',
        success: function (data) {
            if (!data.success) {
                util.log({code: CONFIG.ERRORCODE_LOGIN_RESULT, message: data.msg, result: 'error'});
                util.callback(self.opts.fail, CONFIG.ERRORCODE_LOGIN_RESULT, data.msg, data.success);
                return false;
            }
            self.assignment(data);
            util.callback(self.opts.success, CONFIG.CODE_LOGIN, '初始化成功', 'ok');
            self.state.setLoginState(true);

            var opts = {
                host: self.host,
                sessionId: self.sessionId,
                roomid: self.opts.roomId,
                wx: self.opts.wx
            };

            self.data = data;

            callback(opts);
        },
        fail: function () {
            util.callback(self.opts.fail, CONFIG.ERRORCODE_LOGIN_TIMEOUT, '初始化超时', 'fail');
        }
    });
};

Login.prototype.assignment = function (data) {

    var datas = data.datas;
    var meta = datas.meta;

    if (!meta) {
        return;
    }

    //connect io
    this.host = datas.pusherNode.primary;
    this.sessionId = datas.sessionId;

    //get player url
    this.userId = this.opts.userId;
    this.videoId = datas.live.encryptRecordvideoId;

    //login datas
    this.roomData(datas.room);
    this.templateData(datas.template);
    this.pagesData(meta.pageChange);
    this.qaData(meta.question, meta.answer);
    this.drawsData(meta.draw);
    this.pageChangeData(meta.pageChange);
    this.chatLogsData(meta.chatLog);

    //sync
    this.chatLogsSyncData();
    this.emitter.pub('drawing_board_play_back', meta);
    var self = this;
    this.emitter.sub('drawingboard_init', function () {
        self.emitter.pub('drawing_board_play_back', meta);
    });

};

Login.prototype.chatLogsSyncData = function () {
    var self = this;
    this.emitter.sub('timeupdate', function (e) {
        var ft = 0;
        try {
            ft = e.detail.currentTime;
        } catch (e) {
        }
        if (ft &lt;= 0) {
            return;
        }

        if (!self.CHATLOGS.length) {
            return;
        }

        var chatLog = self.CHATLOGS[0];

        while (chatLog.time &lt;= ft) {
            var cl = self.CHATLOGS.shift();
            self.cache.push({
                userid: cl.userId,
                username: cl.userName,
                time: cl.time,
                msg: cl.content,
                useravatar: cl.userAvatar,
                userRole: cl.userRole,
                usercustommark: cl.userCustomMark
            });
            if (!self.CHATLOGS.length) {
                break;
            }
            chatLog = self.CHATLOGS[0];
        }
    });
};

/**
 * @event room_info
 * @description 回放房间信息
 * @example
 * ccsdk.live.on('room_info',function(data){
 *    //console.log(data);
 * })
 */

Login.prototype.roomData = function (room) {
    this.room = room;
    util.log('room_info', this.room);
    this.emitter.emit('room_info', this.room);
};

/**
 * @event template_info
 * @description 回放模版信息
 * @example
 * ccsdk.replay.on('template_info',function(data){
 *    //console.log(data);
 * })
 */

Login.prototype.templateData = function (template) {
    this.template = template;
    util.log('template_info', this.template);
    this.emitter.emit('template_info', this.template);
};

/**
 * @event pages_info
 * @description 文档信息
 * @example
 * ccsdk.replay.on('pages_info',function(data){
 *    //console.log(data);
 * })
 */

/**
 * @event pages_change_sync
 * @description 同步返回文档信息
 * @example
 * ccsdk.replay.on('pages_change_sync',function(data){
 *    //console.log(data);
 * })
 */

Login.prototype.pagesData = function (pages) {
    var pages = pages;
    for (var i = 0; i &lt; pages.length; i++) {
        var imgUrl = pages[i].url;
        if (imgUrl.indexOf('//') > 0) {
            imgUrl = imgUrl.replace('http', 'https');
            pages[i].url = imgUrl;
        }
    }
    this.pages = pages;
    util.log('pages_info', this.pages);
    this.emitter.emit('pages_info', pages);
};

/**
 * @event questions_info
 * @description 提问信息
 * @example
 * ccsdk.replay.on('questions_info',function(data){
 *    //console.log(data);
 * })
 */

/**
 * @event answers_info
 * @description 回答信息
 * @example
 * ccsdk.replay.on('answers_info',function(data){
 *    //console.log(data);
 * })
 */

Login.prototype.qaData = function (questions, answers) {
    var questions = questions;
    var answers = answers;

    if (questions &amp;&amp; questions.length) {
        questions.sort(function (p1, p2) {
            return parseInt(p1.time) - parseInt(p2.time);
        });
        this.questions = questions;
        var qs = [];
        for (var i = 0; i &lt; this.questions.length; i++) {
            var question = questions[i];
            // this.emitter.emit('questions_info', {
            //     'action': 'question',
            //     'value': {
            //         'id': question.encryptId,
            //         'content': question.content,
            //         'userId': question.questionUserId,
            //         'userName': question.questionUserName,
            //         'userAvatar': question.questionUserAvatar,
            //         'isPublish': question.isPublish
            //     }
            // });
            qs.push({
                'action': 'question',
                'value': {
                    'id': question.encryptId,
                    'content': question.content,
                    'userId': question.questionUserId,
                    'userName': question.questionUserName,
                    'userAvatar': question.questionUserAvatar,
                    'isPublish': question.isPublish,
                    'time': question.time,
                }
            });
        }
        util.log('questions_info', qs);
        this.emitter.emit('questions_info', qs);
    }

    if (answers &amp;&amp; answers.length) {
        answers.sort(function (p1, p2) {
            return parseInt(p1.time) - parseInt(p2.time);
        });
        this.answers = answers;
        var as = [];
        for (var i = 0; i &lt; this.answers.length; i++) {
            var answer = answers[i];
            // this.emitter.emit('answers_info', {
            //     'action': 'answer',
            //     'value': {
            //         'questionId': answer.encryptId,
            //         'content': answer.content,
            //         'userId': answer.answerUserId,
            //         'isPrivate': answer.isPrivate,
            //         'userName': answer.answerUserName,
            //         'userAvatar': answer.answerUserAvatar,
            //         'userRole': answer.answerUserRole
            //     }
            // });
            as.push({
                'action': 'answer',
                'value': {
                    'questionId': answer.encryptId,
                    'content': answer.content,
                    'userId': answer.answerUserId,
                    'isPrivate': answer.isPrivate,
                    'userName': answer.answerUserName,
                    'userAvatar': answer.answerUserAvatar,
                    'userRole': answer.answerUserRole
                }
            });
        }
        util.log('answers_info', as);
        this.emitter.emit('answers_info', as);
    }
};

Login.prototype.drawsData = function (draws) {
    if (draws &amp;&amp; draws.length) {
        this.draws = draws;
    }
};

Login.prototype.pageChangeData = function (pageChanges) {
    var pageChanges = pageChanges;

    if (pageChanges &amp;&amp; pageChanges.length) {
        pageChanges.sort(function (p1, p2) {
            return parseInt(p1.time) - parseInt(p2.time);
        });
        this.pageChanges = pageChanges;
    }
};

/**
 * @event chat_msg_info
 * @description 聊天信息
 * @example
 * ccsdk.replay.on('chat_msg_info',function(data){
 *    //console.log(data);
 * })
 */

Login.prototype.chatLogsData = function (chatLogs) {
    var chatLogs = chatLogs;
    var ct = [];
    if (chatLogs &amp;&amp; chatLogs.length) {
        chatLogs.sort(function (p1, p2) {
            return parseInt(p1.time) - parseInt(p2.time);
        });
        for (var i = 0; i &lt; chatLogs.length; i++) {
            var chatLog = chatLogs[i];
            // this.emitter.emit('chat_msg_info', {
            //     userid: chatLog.userId,
            //     username: chatLog.userName,
            //     time: chatLog.time,
            //     msg: chatLog.content,
            //     useravatar: chatLog.userAvatar,
            //     userRole: chatLog.userRole,
            //     usercustommark: chatLog.userCustomMark
            // });
            ct.push({
                userid: chatLog.userId,
                username: chatLog.userName,
                time: chatLog.time,
                msg: chatLog.content,
                useravatar: chatLog.userAvatar,
                userRole: chatLog.userRole,
                usercustommark: chatLog.userCustomMark
            });
        }
        this.chatLogs = chatLogs;
        this.CHATLOGS = chatLogs;
        util.log('chat_msg_info', ct);
        this.emitter.emit('chat_msg_info', ct);
    }
};

Login.prototype.checkout = function () {
    //校验参数合法性
    if (typeof this.opts.wx !== 'object'
        || typeof this.opts.userId !== 'string'
        || typeof this.opts.roomId !== 'string'
        || typeof this.opts.recordId !== 'string'
        || typeof this.opts.viewername !== 'undefined' &amp;&amp; typeof this.opts.viewername !== 'string'
        || typeof this.opts.viewertoken !== 'undefined' &amp;&amp; typeof this.opts.viewertoken !== 'string'
        || typeof this.opts.success !== 'undefined' &amp;&amp; typeof this.opts.success !== 'function'
        || typeof this.opts.fail !== 'undefined' &amp;&amp; typeof this.opts.fail !== 'function'
    ) {
        return false;
    }
    return true;
};

module.exports = Login;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Events</h3><ul><li><a href="global.html#event:answers_info">answers_info</a></li><li><a href="global.html#event:chat_msg_info">chat_msg_info</a></li><li><a href="global.html#event:chat_msg_sync">chat_msg_sync</a></li><li><a href="global.html#event:pages_change_sync">pages_change_sync</a></li><li><a href="global.html#event:pages_info">pages_info</a></li><li><a href="global.html#event:questions_info">questions_info</a></li><li><a href="global.html#event:room_info">room_info</a></li><li><a href="global.html#event:template_info">template_info</a></li></ul><h3>Global</h3><ul><li><a href="global.html#configPlayer">configPlayer</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#exitFullScreen">exitFullScreen</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#listenerended">listenerended</a></li><li><a href="global.html#listenerplay">listenerplay</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#pause">pause</a></li><li><a href="global.html#play">play</a></li><li><a href="global.html#playbackRate">playbackRate</a></li><li><a href="global.html#quit">quit</a></li><li><a href="global.html#requestFullScreen">requestFullScreen</a></li><li><a href="global.html#seek">seek</a></li><li><a href="global.html#setDebug">setDebug</a></li><li><a href="global.html#showEm">showEm</a></li><li><a href="global.html#timeupdate">timeupdate</a></li><li><a href="global.html#waiting">waiting</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Aug 14 2018 10:09:07 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
