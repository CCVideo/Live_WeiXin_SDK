<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: live/manager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: live/manager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
  方法模块
*/
var util = require('../module/util');
var CONFIG = require('../module/config').LIVE;

function Manager(stateMachine, observer) {

    var _login = {};
    var _player = {};
    var _history = {};
    var _client = {};
    var _route = 0;
    var _mode = 'video';
    var _pusher = {};

    var _vdrop = -1;
    var _bytes = [];
    var _block = -1;
    var timer = {};

    var _ctx = {};

    this.getCtx = function () {
        return _ctx;
    };

    var setCtx = function (ctx) {
        _ctx = ctx;
    };

    this.init = function (login, pusher, player, history) {
        _login = login;
        _player = player;
        _history = history;
        _pusher = pusher;
    };

    /**
     * @description 开启开发者调试功能
     * @param {Boolean} b 是否开启debug调试功能
     * @default false
     * @return {Boolean} 返回true调用成功，false调用失败
     * @example ccsdk.live.setDebug(true);
     */

    this.setDebug = function (b) {
        if (typeof b !== 'boolean') {
            return false;
        }
        CONFIG.CONSOLE_LOG = b;
        return true;
    };

    /**
     * @description 配置live-player组件
     * @param {Object} that 微信小程序全局this对象
     * @param {Object} wx 微信小程序全局wx对象
     * @return {Object} 返回live-player实例
     * @example onLoad:function(){
     *     ccsdk.live.configLivePlayer(this,wx);
     * }
     */

    this.configLivePlayer = function (that, wx) {

        if (typeof that !== 'object') {
            util.log('configLivePlayer', '参数错误');
            return false;
        }

        _client = that;

        //TO DO 返回给画板
        // if (stateMachine.isHistoryDataState()) {
        //   //发送历史信息
        //   var historyData = _history.getHistoryData();
        //   if (historyData) {
        //     observer.pub('historyData', historyData);
        //   }
        // }

        if (stateMachine.isPlayerDataState()) {
            //live-player加载成功主动调用配置playerUrl
            var playerUrl = _player.getPlayerUrl();
            if (playerUrl.host[0]) {
                _client.setData({
                    playerUrl: playerUrl.host[0]
                });
            }
        }

        //登陆成功后接收配置playerUrl事件
        observer.sub('configLivePlayer', function (data) {
            _client.setData({
                playerUrl: data.host[0]
            });
        });

        var ctx = wx.createLivePlayerContext('player');

        setCtx(ctx);

        return ctx;

    };

    /**
     * @description 发送公聊
     * @param {String} msg 聊天信息，聊天信息必须是字符串并小于140字且不能为空
     * @return {Boolean} 返回true调用成功，返回false发送失败
     * @example ccsdk.live.sendPublicChatMsg('hello world');
     */

    this.sendPublicChatMsg = function (msg) {

        if (!checkout()) {
            util.log('sendPublicChatMsg', '状态不满足');
            return false;
        }

        //参数校验
        if (typeof msg !== 'string' || msg.length > 140 || !msg) {
            util.log('聊天信息必须是字符串并小于300字且不能为空');
            return false;
        }

        //发送聊天 
        observer.pub('send_chat_message', msg);

        return true;
    };

    /**
     * @description 发送私聊
     * @param {String} touserId 接收者的viewerid
     * @param {String} touserName 接收者的viewername
     * @param {String} msg 消息内容
     * @return {Boolean} 返回true调用成功，返回false发送失败
     * @example ccsdk.live.sendPrivateChatMsg('33ed40d2d7b746919219789733b5bdd4','name','hello world');
     */

    this.sendPrivateChatMsg = function (touserId, touserName, msg) {
        if (!checkout()) {
            util.log('sendPrivateChatMsg', '状态不满足');
            return false;
        }

        //参数校验
        if (typeof touserId !== 'string' || typeof touserName !== 'string' || typeof msg !== 'string' || msg.length > 300 || !msg) {
            util.log('参数错误或聊天信息必须是字符串并小于300字且不能为空');
            return false;
        }

        var json = {
            'fromuserid': _login.getData().datas.viewer.id,
            'fromusername': _login.getData().datas.viewer.name,
            'touserid': touserId,
            'tousername': touserName,
            'msg': msg.trim(),
            'time': util.formatTime(new Date())
        };

        observer.pub('send_private_chat', JSON.stringify(json));

        return true;
    };

    /**
     * @description 发送问题
     * @param {String} content 发送问题，msg:消息内容
     * @return {Boolean} 返回true调用成功，返回false发送失败
     * @example ccsdk.live.sendQuestionMsg('hello world');
     */

    this.sendQuestionMsg = function (content) {

        if (!checkout()) {
            util.log('sendQuestionMsg', '状态不满足');
            return false;
        }

        //参数校验
        if (typeof content !== 'string' || content.length > 300 || !content) {
            util.log('聊天信息必须是字符串并小于300字且不能为空');
            return false;
        }

        var json = {
            'action': 'question',
            'value': {
                'userId': _login.getData().datas.viewer.id,
                'userName': _login.getData().datas.viewer.name,
                'content': content
            }
        };

        observer.pub('send_question', JSON.stringify(json));

        return true;
    };

    /**
     * @description 切换线路
     * @param {Number} route 观看直播线路，可选值0,1,2
     * @return {Boolean} 返回true调用成功，返回false发送失败
     * @example ccsdk.live.streamRoute(0);
     */

    this.streamRoute = function (route) {

        if (!checkout()) {
            util.log('streamRoute', '状态不满足');
            return false;
        }

        var playerUrls = _player.getPlayerUrl();

        if (typeof route !== 'number' || route > (playerUrls.host.length - 1) || route &lt; 0) {
            util.log('streamRoute', '参数错误');
            return false;
        }

        _route = route;

        if (_mode === 'video') {
            _client.setData({
                playerUrl: playerUrls.host[parseInt(route)]
            });
        } else if (_mode === 'audio') {
            _client.setData({
                playerUrl: playerUrls.audioStream[parseInt(route)]
            });
        }
        return true;
    };

    /**
     * @description 切换模式
     * @param {String} mode 观看直播模式，可选值video、audio
     * @return {Boolean} 返回true调用成功，返回false调用失败
     * @example ccsdk.live.streamMode('video');
     */

    this.streamMode = function (mode) {

        if (!checkout()) {
            util.log('streamMode', '状态不满足');
            return false;
        }

        if (typeof mode !== 'string') {
            util.log('streamMode', '参数错误');
            return false;
        }

        _mode = mode;

        var playerUrls = _player.getPlayerUrl();

        if (mode === 'video') {
            _client.setData({
                playerUrl: playerUrls.host[parseInt(_route)]
            });
        } else if (mode === 'audio') {
            _client.setData({
                playerUrl: playerUrls.audioStream[parseInt(_route)]
            });
        } else {
            util.log('streamMode', '参数错误');
            return false;
        }
        return true;
    };

    /**
     * @description 退出登录
     * @return {Boolean} 返回true调用成功，返回false发送失败
     * @example ccsdk.live.quit();
     */

    this.quit = function () {
        if (!checkout()) {
            util.log('quit', '状态不满足');
            return false;
        }
        stateMachine.setLoginState(false);
        stateMachine.setIoConnectState(false);
        stateMachine.setFirstListenerEvents(true);
        stateMachine.setFirstListener(true);
        _pusher.getIo().close();
        stateMachine.setReportLoginResult(false);
        timerIndex = 0;
        stateMachine.setReportPlayerResult(false);
        return true;
    };

    var reportLoginResult = function () {
        if (stateMachine.isReportLoginResult()) {
            return false;
        }
        stateMachine.setReportLoginResult(true);

        _player.init(_login.getParam(), _login.getData(), reportCallback);

        function reportCallback() {
            //统计上报
            var reportData = {
                userid: _login.getParam().userId,
                roomid: _login.getParam().roomId,
                liveid: _player.getData().live.liveId,
                viewerid: _login.getData().datas.viewer.id,
                upid: _player.getData().upid,
                terminal: 1,
                ua: 40
            };

            if (!CONFIG.URL.REPORT) {
                return;
            }

            wx.request({
                url: CONFIG.URL.REPORT + '/report/live/login',
                data: reportData,
                success: function (res) {
                    util.log('直播⻚面加载完成(登录成功)上报成功', reportData);
                },
                fail: function (res) {
                    util.log('直播⻚面加载完成(登录成功)上报超时', reportData);
                }
            });
        };
    };

    this.reportPlayResult = function (e) {

        reportLoginResult();

        var reportData = {
            userid: _login.getParam().userId,
            roomid: _login.getParam().roomId,
            liveid: _player.getData().live.liveId,
            viewerid: _login.getData().datas.viewer.id,
            upid: _player.getData().upid,
            terminal: 1,
            ua: 40,
        };
        var code = e.detail.code;
        if (code === 2004) {
            reportData.result = 0;
            if (stateMachine.isReportPlayerResult()) {
                util.log('直播播放器器播放结果已上报');
                clearInterval(timer);
                timerIndex = 0;
                timer = setInterval(timerCallback, 1000);
                return false;
            }
            stateMachine.setReportPlayerResult(true);
            reportRequest('/report/live/play', reportData, '直播播放器器播放结果上报');

            clearInterval(timer);
            timerIndex = 0;
            timer = setInterval(timerCallback, 1000);

        } else if (code === -2301 || code === -2302 || code === 2101 || code === 2102 || code === 2103 || code === 3001 || code === 3002 || code === 3003 || code === 3005) {
            reportData.result = 1;
            reportRequest('/report/live/play', reportData, '直播播放器器播放结果上报');
            stateMachine.setReportPlayerResult(false);
        }

        //计算丢帧
        if (code === 2107) {
            _vdrop++;
        }

        //计算卡顿
        if (code === 2105) {
            _block++;
        }

    };

    this.reportPlaying = function (e) {
        var info = e.detail.info;
        if (_mode === 'video') {
            _bytes.push(info.videoBitrate);
        } else {
            _bytes.push(info.audioBitrate);
        }

    };

    var reportRequest = function (path, data, msg) {
        if (!CONFIG.URL.REPORT) {
            return;
        }
        wx.request({
            url: CONFIG.URL.REPORT + path, //仅为示例，并非真实的接口地址
            data: data,
            header: {
                'content-type': 'application/json' // 默认值
            },
            success: function () {
                util.log(msg + '成功', data);
            },
            fail: function () {
                util.log(msg + '超时', data);
            }
        });
    };

    var timerIndex = 0;

    function timerCallback() {

        if (!stateMachine.isLoginState()) {
            return false;
        }

        timerIndex++;

        if (timerIndex >= 10) {

            var avgbyte = 0;
            var totalbyte = 0;
            for (var i = 0; i &lt; _bytes.length; i++) {
                totalbyte += _bytes[i];
            }
            avgbyte = totalbyte / _bytes.length;

            var reportData = {
                userid: _login.getParam().userId,
                roomid: _login.getParam().roomId,
                liveid: _player.getData().live.liveId,
                viewerid: _login.getData().datas.viewer.id,
                upid: _player.getData().upid,
                terminal: 1,
                ua: 40,
                vdrop: _vdrop,
                avgbytes: isNaN(avgbyte) ? -1 : avgbyte,
                block: _block
            };
            if (reportData.avgbytes === -1) {
                clearInterval(timer);
                return false;
            }
            reportRequest('/report/live/heartbeat', reportData, '直播中上报统计');

            _vdrop = -1;
            _bytes = [];
            _block = -1;
            timerIndex = 0;
        }
    }

    var checkout = function () {
        if (!stateMachine.isLoginState() || !stateMachine.isIoConnectState()) {
            return false;
        }
        return true;
    };

}

module.exports = Manager;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Events</h3><ul><li><a href="global.html#event:announcement">announcement</a></li><li><a href="global.html#event:announcement_info">announcement_info</a></li><li><a href="global.html#event:answer">answer</a></li><li><a href="global.html#event:answer_log">answer_log</a></li><li><a href="global.html#event:chat_log">chat_log</a></li><li><a href="global.html#event:chat_message">chat_message</a></li><li><a href="global.html#event:draw">draw</a></li><li><a href="global.html#event:draw_log">draw_log</a></li><li><a href="global.html#event:end_stream">end_stream</a></li><li><a href="global.html#event:information">information</a></li><li><a href="global.html#event:isPublishing_log">isPublishing_log</a></li><li><a href="global.html#event:page_change">page_change</a></li><li><a href="global.html#event:page_change_log">page_change_log</a></li><li><a href="global.html#event:private_chat">private_chat</a></li><li><a href="global.html#event:private_chat_self">private_chat_self</a></li><li><a href="global.html#event:publish_question">publish_question</a></li><li><a href="global.html#event:publish_stream">publish_stream</a></li><li><a href="global.html#event:question">question</a></li><li><a href="global.html#event:question_log">question_log</a></li><li><a href="global.html#event:room_info">room_info</a></li><li><a href="global.html#event:room_teachers">room_teachers</a></li><li><a href="global.html#event:room_user_count">room_user_count</a></li><li><a href="global.html#event:silence_user_chat_message">silence_user_chat_message</a></li><li><a href="global.html#event:template_info">template_info</a></li><li><a href="global.html#event:viewer_info">viewer_info</a></li></ul><h3>Global</h3><ul><li><a href="global.html#configLivePlayer">configLivePlayer</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#quit">quit</a></li><li><a href="global.html#sendPrivateChatMsg">sendPrivateChatMsg</a></li><li><a href="global.html#sendPublicChatMsg">sendPublicChatMsg</a></li><li><a href="global.html#sendQuestionMsg">sendQuestionMsg</a></li><li><a href="global.html#setDebug">setDebug</a></li><li><a href="global.html#showEm">showEm</a></li><li><a href="global.html#streamMode">streamMode</a></li><li><a href="global.html#streamRoute">streamRoute</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Jul 30 2018 17:01:14 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
